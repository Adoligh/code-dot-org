var lastAjaxRequest;
var lastServerResponse = {};
var sendReport = function(report) {
  var thisAjax;

  var data = $.extend({}, report);
  delete data.onComplete;

  lastAjaxRequest = thisAjax = Frame.load({
    type: 'POST',
    url: report.callback,
    contentType: 'application/x-www-form-urlencoded',
    data: data,
    dataType: 'json',
    success: function (response) {
      if (thisAjax !== lastAjaxRequest) {
        return;
      }

      lastAjaxRequest = null;
      lastServerResponse.report_error = null;
      lastServerResponse.nextRedirect = response['redirect'];
      lastServerResponse.previousLevelRedirect = response['previous_level'];
      lastServerResponse.videoInfo = response['video_info'];

      if (report.onComplete)
        report.onComplete(response);
    },
    error: function (xhr, textStatus, thrownError) {
      if (thisAjax !== lastAjaxRequest) {
        return;
      }
      report['error'] = xhr.responseText;

      lastAjaxRequest = null;
      if (report.fallbackResponse) {
        var response = report.fallbackResponse[report.pass ? 'success' : 'failure'];

        lastServerResponse.report_error = report['error'];
        lastServerResponse.nextRedirect = response['redirect'];
        lastServerResponse.previousLevelRedirect = response['previous_level'];
        lastServerResponse.videoInfo = response['video_info'];
      }

      if (report.onComplete)
        report.onComplete(response);
    }
  });
};

var cancelReport = function() {
  if (lastAjaxRequest) {
    lastAjaxRequest.abort();
  }
  lastAjaxRequest = null;
};
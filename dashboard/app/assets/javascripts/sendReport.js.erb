var lastAjaxRequest;
var lastServerResponse = {};
var sendReport = function(report, scriptPath) {
  var thisAjax;

  var data = $.extend({}, report);
  delete data.onComplete;

  var reportComplete = function (response, textStatus, xhr) {
    if (thisAjax !== lastAjaxRequest) {
      return;
    }

    lastAjaxRequest = null;
    lastServerResponse = {
      report_error: report['error']
    };
    if (response) {
      lastServerResponse.nextRedirect = response['redirect'];
      lastServerResponse.previousLevelRedirect = response['previous_level'];
      lastServerResponse.videoInfo = response['video_info'];
      response.levelPath = scriptPath;  // This used to be passed back from the milestone API
    }

    if (report.onComplete)
      report.onComplete(response);
  };

  lastAjaxRequest = thisAjax = Frame.load({
    type: 'POST',
    url: report.callback,
    contentType: 'application/x-www-form-urlencoded',
    data: data,
    dataType: 'json',
    success: reportComplete,
    error: function (xhr, textStatus, thrownError) {
      report['error'] = xhr.responseText;
      reportComplete(report.fallbackResponse[report.pass ? 'success' : 'failure']);
    }
  });
};

var cancelReport = function() {
  if (lastAjaxRequest) {
    lastAjaxRequest.abort();
  }
  lastAjaxRequest = null;
};